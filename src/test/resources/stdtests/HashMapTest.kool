import <kool.std.HashMap>
import <kool.std.Tester>

var ti = new Tester<Int>()
var ts = new Tester<String>()
var to = new Tester<Option<Int>>()
var tb = new Tester<Bool>()

IntMap()
StringMap()
LargeMap()
InitialCapacity()
ToString()
Get()
ContainsKey()
ContainsValue()
Iterators()
Equals()
Remove()
AddAll()

println("All tests succeded!")

Def IntMap() = {
    var map = new HashMap<Int, Int>()
    map[1] = 2
    ti.AssertEquals(map[1], 2)
    ti.AssertEquals(map.Size(), 1)
    map[1] = 3
    ti.AssertEquals(map[1], 3)
    ti.AssertEquals(map.Size(), 1)
    map[5] = 5
    ti.AssertEquals(map[5], 5)
    ti.AssertEquals(map.Size(), 2)
}

Def StringMap() = {
    var map = new HashMap<String, Int>()
    map["1"] = 2
    ti.AssertEquals(map["1"], 2)
    ti.AssertEquals(map.Size(), 1)
    map["1"] = 3
    ti.AssertEquals(map["1"], 3)
    ti.AssertEquals(map.Size(), 1)
    map["5"] = 5
    ti.AssertEquals(map["5"], 5)
    ti.AssertEquals(map.Size(), 2)
}

Def LargeMap() = {
    var map = new HashMap<Int, Int>()
    for(var i = 0; i < 5000; i++){
        map[i] = i + 1
        ti.AssertEquals(map.Size(), i + 1)
    }

    for(var i = 0; i < 5000; i++)
        ti.AssertEquals(map[i], i + 1)
}


Def InitialCapacity() = {
    testCapacity(1, 2)
    testCapacity(2, 2)
    testCapacity(3, 4)
    testCapacity(512, 512)
    testCapacity(513, 1024)
}

Def ToString() = {
    var map = new HashMap<Int, Int>()
    map[1] = 5
    map[2] = 2
    map[64] = -1
    // when string comparison works:
    //ts.AssertEquals(map.toString(), "(1 -> 5)\n(2 -> 2)\n(64 -> -1)\n")
}

Def Get() = {
    var map = new HashMap<Int, Int>()
    map[1] = 5
    map[2] = 4
    to.AssertEquals(map.Get(1), new Option<Int>(5))
    to.AssertEquals(map.Get(2), new Option<Int>(4))
    to.AssertEquals(map.Get(3), new Option<Int>())
}

Def ContainsKey() = {
    var map = new HashMap<Int, Int>()
    map[1] = 5
    map[2] = 4
    tb.AssertEquals(map.ContainsKey(1), true)
    tb.AssertEquals(map.ContainsKey(2), true)
    tb.AssertEquals(map.ContainsKey(3), false)
}

Def ContainsValue() = {
    var map = new HashMap<Int, Int>()
    map[1] = 5
    map[2] = 4
    tb.AssertEquals(map.ContainsValue(5), true)
    tb.AssertEquals(map.ContainsValue(4), true)
    tb.AssertEquals(map.ContainsValue(1), false)
}

Def Iterators() = {
    var map = new HashMap<Int, Int>()
    var entries = new Entry<Int, Int>[4]
    entries[0] = new Entry<Int, Int>(1, 1, 1)
    entries[1] = new Entry<Int, Int>(2, 6, 1)
    entries[2] = new Entry<Int, Int>(90, -5, 1)
    entries[3] = new Entry<Int, Int>(-2, 35, 1)

    for(var i = 0; i < entries.length; i++){
        map[entries[i].Key] = entries[i].Value
    }

    {
        var it = map.EntryIterator()
        while(it.HasNext())
            ti.Assert(containsEntry(it.Next(), entries))
    }

    {
        var it = map.KeyIterator()
        while(it.HasNext())
            ti.Assert(containsKey(it.Next(), entries))
    }

    {
        var it = map.ValueIterator()
        while(it.HasNext())
            ti.Assert(containsValue(it.Next(), entries))
    }


}

Def Equals() = {
    var map1 = new HashMap<Int, Int>()
    var map2 = new HashMap<Int, Int>()
    var map3 = new HashMap<Int, Int>()
    var map4 = new HashMap<Int, Int>()
    var map5 = new HashMap<Int, Int>()

    map1[1] = 5
    map1[2] = 6
    map1[3] = 7
    map1[4] = 8

    map2[1] = 5
    map2[2] = 6
    map2[3] = 7
    map2[4] = 8

    map3[0] = 5
    map3[2] = 6
    map3[3] = 7
    map3[4] = 8

    map4[1] = 5
    map4[2] = 6
    map4[3] = 8
    map4[4] = 8

    map5[1] = 5
    map5[2] = 6
    map5[3] = 7

    ti.Assert(map1 == map2)
    ti.Assert(map2 == map1)

    ti.Assert(map1 != map3)
    ti.Assert(map1 != map4)
    ti.Assert(map1 != map5)

    ti.Assert(map2 != map3)
    ti.Assert(map2 != map4)
    ti.Assert(map2 != map5)

    ti.Assert(map3 != map1)
    ti.Assert(map3 != map2)
    ti.Assert(map3 != map4)
    ti.Assert(map3 != map5)

    ti.Assert(map4 != map1)
    ti.Assert(map4 != map2)
    ti.Assert(map4 != map3)
    ti.Assert(map4 != map5)

    ti.Assert(map5 != map1)
    ti.Assert(map5 != map2)
    ti.Assert(map5 != map3)
    ti.Assert(map5 != map4)
}

Def Remove() = {
    var map = new HashMap<Int, Int>()

    map[5] = 10
    map[4] = 11
    map[3] = 12

    ti.AssertEquals(map.Size(), 3)
    ti.Assert(map.ContainsKey(5))
    ti.Assert(map.ContainsValue(10))
    ti.Assert(map.ContainsKey(4))
    ti.Assert(map.ContainsValue(11))
    ti.Assert(map.ContainsKey(3))
    ti.Assert(map.ContainsValue(12))

    var map2 = map - 5

    ti.AssertEquals(map2.Size(), 2)
    ti.Assert(!map2.ContainsKey(5))
    ti.Assert(!map2.ContainsValue(10))
    ti.Assert(map2.ContainsKey(4))
    ti.Assert(map2.ContainsValue(11))
    ti.Assert(map2.ContainsKey(3))
    ti.Assert(map2.ContainsValue(12))

    map.Remove(5)

    ti.AssertEquals(map.Size(), 2)
    ti.Assert(!map.ContainsKey(5))
    ti.Assert(!map.ContainsValue(10))
    ti.Assert(map.ContainsKey(4))
    ti.Assert(map.ContainsValue(11))
    ti.Assert(map.ContainsKey(3))
    ti.Assert(map.ContainsValue(12))

    map.Remove(4)

    ti.AssertEquals(map.Size(), 1)
    ti.Assert(!map.ContainsKey(5))
    ti.Assert(!map.ContainsValue(10))
    ti.Assert(!map.ContainsKey(4))
    ti.Assert(!map.ContainsValue(11))
    ti.Assert(map.ContainsKey(3))
    ti.Assert(map.ContainsValue(12))

    map.Remove(3)

    ti.AssertEquals(map.Size(), 0)
    ti.Assert(!map.ContainsKey(5))
    ti.Assert(!map.ContainsValue(10))
    ti.Assert(!map.ContainsKey(4))
    ti.Assert(!map.ContainsValue(11))
    ti.Assert(!map.ContainsKey(3))
    ti.Assert(!map.ContainsValue(12))

    map.Remove(2)

    ti.AssertEquals(map.Size(), 0)
    ti.Assert(!map.ContainsKey(5))
    ti.Assert(!map.ContainsValue(10))
    ti.Assert(!map.ContainsKey(4))
    ti.Assert(!map.ContainsValue(11))
    ti.Assert(!map.ContainsKey(3))
    ti.Assert(!map.ContainsValue(12))
}

Def AddAll() = {
    var map1 = new HashMap<Int, Int>()
    var map2 = new HashMap<Int, Int>()

    map1[1] = 2
    map1[2] = 3

    map2[2] = 3
    map2[3] = 4
    map2[4] = 5

    map1.AddAll(map2)
    ti.AssertEquals(map1.Size(), 4)
    tb.AssertEquals(map1.ContainsKey(1), true)
    tb.AssertEquals(map1.ContainsKey(2), true)
    tb.AssertEquals(map1.ContainsKey(3), true)
    tb.AssertEquals(map1.ContainsKey(4), true)

    tb.AssertEquals(map1.ContainsValue(2), true)
    tb.AssertEquals(map1.ContainsValue(3), true)
    tb.AssertEquals(map1.ContainsValue(4), true)
    tb.AssertEquals(map1.ContainsValue(5), true)

    map2.AddAll(map1)

    tb.Assert(map1 == map2)
}

def testCapacity(given: Int, expected: Int) = {
    var map = new HashMap<Int, Int>(given, 0.75)
    ti.AssertEquals(map.Capacity(), expected)
}

def containsEntry(entry: Entry<Int, Int>, entries: Entry<Int, Int>[]) = {
    for(var i = 0; i < entries.length; i++)
        if(entries[i] == entry)
            return true
    return false
}

def containsKey(key: Int, entries: Entry<Int, Int>[]) = {
    for(var i = 0; i < entries.length; i++)
        if(entries[i].Key == key)
            return true
    return false
}

def containsValue(value: Int, entries: Entry<Int, Int>[]) = {
    for(var i = 0; i < entries.length; i++)
        if(entries[i].Value == value)
            return true
    return false
}